# MCP PostgreSQL Server を使用したテストデータ作成ハンズオン

## 事前準備：データベース構造の理解

### 課題 0: ER図の作成

MCPツールでテストデータを作成する前に、データベースの構造とテーブル間のリレーションを理解することが重要です。

**課題内容**

1. **Prismaスキーマの確認**

   ```bash
   # Prismaスキーマファイルを確認
   cat packages/database/prisma/schema.prisma
   ```

2. **ER図の作成（MCPツール使用）**
   - MCPツールを使用してデータベースのスキーマ情報を取得
   - 取得した情報を元にMermaidのER図を作成
   - 全てのテーブルとリレーションを含む完全なER図を生成

**課題の確認ポイント**

- [ ] MCPツールでテーブル構造を取得できている
- [ ] 各テーブルの主キーを理解している
- [ ] 外部キーの関係を正しく把握している
- [ ] 1:1、1:N、N:Nの関係を区別できている
- [ ] ビジネスロジックに基づいたデータの流れを理解している

**MCPツールを使用したER図作成手順**

1. **データベース接続の確認**

   ```
   MCPツールのconnect_dbを使用してデータベースに接続してください
   ```

2. **スキーマ一覧の取得**

   ```
   MCPツールのlist_schemasを使用してスキーマ一覧を取得してください
   ```

3. **テーブル一覧の取得**

   ```
   MCPツールのlist_tablesを使用してテーブル一覧を取得してください
   ```

4. **テーブル構造の詳細取得**

   ```
   MCPツールのdescribe_tableを使用して各テーブルの構造を詳しく取得してください
   ```

5. **リレーション情報の取得**

   ```
   MCPツールのqueryを使用して外部キー制約と参照関係を全て取得してください
   ```

6. **Mermaidコードの生成**
   以下の情報を含むMermaidのER図を作成してください：
   - 全17テーブルの構造
   - 各テーブル間のリレーション
   - 関係性の種類（1:1、1:N、N:N）

7. **リレーション分析**
   作成したER図から以下を分析してください：
   - 各テーブルの関係数
   - 最も関係が多いテーブル
   - 依存関係の深さ
   - 循環参照の有無

**課題の成果物**

MCPツールを使用して以下を作成してください：

1. **完全なMermaidのER図**
   - 全17テーブルの詳細な構造定義
   - 各テーブル間のリレーション（約28の関係）
   - フィールドの型とキー情報（PK、FK、UK）

2. **リレーション分析レポート**
   - 各テーブルの関係数
   - 中心となるテーブルの特定
   - 依存関係の深さ
   - 循環参照の有無

**実際にMCPツールで取得した結果をもとに上記を作成し、データベース構造の理解を深めてください。**

## なぜこのような複雑なリレーションが必要なのか

EC通販システムでは、以下のビジネス要件を満たすために複雑なリレーションが必要です：

### 1. マルチサイト・マルチショップ対応

```
Site → Shop → Order
```

- **理由**: 1つの企業が複数のECサイト（本店、アウトレット、期間限定ショップ）を運営
- **メリット**: サイト別の売上分析、在庫管理、顧客管理が可能
- **実例**: 楽天市場内の複数店舗、Amazon内の複数ブランド

### 2. 注文の複雑性への対応

```
Order → OrderItem → Product → Category/Supplier
```

- **理由**: 1つの注文に複数商品、商品には分類と仕入先が必要
- **メリット**:
  - 注文明細ごとの管理（個別キャンセル、部分発送対応）
  - カテゴリ別売上分析
  - サプライヤー別発注管理
- **実例**: Amazonの複数商品注文、商品別配送状況

### 3. 決済の多様性と追跡

```
Order → PaymentInfo → PaymentMethod
```

- **理由**: 現代のEC決済は多様（クレジット、コンビニ決済、後払い等）
- **メリット**:
  - 決済方法別の分析
  - 決済状況の詳細追跡
  - 返金・キャンセル対応
- **実例**: 複数決済手段の提供、決済状況の詳細管理

### 4. 配送の複雑性

```
Order → Shipment → ShippingAddress
Order → DeliveryMethod → DeliverySlot
```

- **理由**: 配送方法、配送先、配送時間帯の柔軟な管理が必要
- **メリット**:
  - 配送方法別の料金計算
  - 時間帯指定への対応
  - 配送状況の詳細追跡
- **実例**: ヤマト運輸の時間帯指定、当日配送オプション

### 5. 在庫・仕入管理の自動化

```
Order → PurchaseOrder → Receiving
Supplier → Product → OrderItem
```

- **理由**: 注文に応じた自動発注と入荷管理
- **メリット**:
  - 在庫不足の防止
  - 仕入先との連携
  - 入荷予定の可視化
- **実例**: Amazonの自動発注システム、在庫管理システム

### 6. 履歴管理とトレーサビリティ

```
Order → OrderStatusLog
```

- **理由**: 注文状況の変化を全て記録
- **メリット**:
  - 問題発生時の原因追跡
  - 顧客への状況説明
  - 業務改善のための分析
- **実例**: 注文から配送完了までの詳細ログ

### 7. データ正規化によるメリット

- **重複データの排除**: 商品情報、顧客情報の一元管理
- **データ整合性**: 外部キー制約による不正データの防止
- **保守性**: 1箇所の変更で全体に反映
- **拡張性**: 新機能追加時の影響範囲を最小化

### 8. 実際のビジネスシナリオ例

**注文処理フロー**:

1. 顧客が複数商品を注文 → `Order` + `OrderItem`
2. 決済処理 → `PaymentInfo`
3. 在庫確認・発注 → `PurchaseOrder`
4. 商品入荷 → `Receiving`
5. 配送準備 → `Shipment`
6. 配送完了 → `OrderStatusLog`

**分析・レポート**:

- サイト別売上: `Site` → `Order`
- カテゴリ別売上: `Category` → `Product` → `OrderItem`
- サプライヤー別発注: `Supplier` → `PurchaseOrder`
- 配送パフォーマンス: `DeliveryMethod` → `Shipment`

このような複雑なリレーションにより、単純な「商品を売る」という機能だけでなく、現代的なEC事業に必要な高度な管理機能を実現しています。

この事前準備により、MCPツールでテストデータを作成する際に、テーブル間の依存関係を正しく理解してデータを投入できるようになります。

## 学習目標

このハンズオンでは、MCP（Model Context Protocol）PostgreSQL Serverを使用してデータベースにテストデータを効率的に作成する方法を学習します。
複雑なリレーションを持つEC通販システムのデータベースに対して、MCPツールを使用してテストデータを挿入し、実際の開発現場で使えるスキルを身につけることが目標です。

## 想定システム

このプロジェクトは以下のような複雑なリレーションを持つEC通販システムです：

- **注文管理**: 注文 → 注文明細 → 商品 → カテゴリ/サプライヤー
- **決済管理**: 注文 → 決済情報 → 決済方法
- **配送管理**: 注文 → 配送情報 → 配送先住所 → 配送方法
- **在庫管理**: 発注 → 入荷 → 商品 → サプライヤー

## MCPを使用する理由

従来の方法で複雑なリレーションを持つデータベースに1000件のテストデータを作成する場合：

1. **シーダー作成**: 各テーブルのシーダーを個別に作成
2. **依存関係管理**: テーブル間の依存関係を正しく設定
3. **データ整合性**: 外部キー制約やビジネスルールを満たすデータ作成
4. **バリエーション**: 現実的なデータパターンの作成

これらの作業は非常に時間がかかり、エラーも発生しやすいです。
MCPを使用することで、自然言語でデータの要求を伝え、AIが自動的に適切な形式でデータを生成・投入できます。

## MCP PostgreSQL Server の導入

### 1. MCP Server のインストール

```bash
# MCP PostgreSQL Server をインストール
npm install -g mcp-postgres-server

# または直接実行
npx mcp-postgres-server
```

### 2. Claude Code で MCP 設定

```bash
# Claude Code の設定ファイルを確認
cat ~/.config/claude-code/settings.json
```

以下の設定を追加してください：

```json
{
  "mcp": {
    "servers": {
      "postgres": {
        "command": "npx",
        "args": ["-y", "mcp-postgres-server"],
        "env": {
          "PG_HOST": "localhost",
          "PG_PORT": "5432",
          "PG_USER": "user",
          "PG_PASSWORD": "password",
          "PG_DATABASE": "ai_training"
        }
      }
    }
  }
}
```

**注意**: データベース接続情報は実際の環境に合わせて変更してください。

### 3. データベース接続確認

```bash
# PostgreSQL が起動していることを確認
docker compose ps

# データベースに接続できることを確認
pnpm db:studio
```

## ハンズオン実習

### Phase 1: 基本データの作成

まず、基本的なマスタデータを作成します。

**実習 1-1: サイトとショップの作成**

MCPツールを使用して以下のデータを作成してください：

- 3つのサイト（本店、アウトレット、期間限定）
- 各サイトに2つずつショップを作成
- サイトコード、ショップコードは自動生成

**実習 1-2: カテゴリとサプライヤーの作成**

- 10個のカテゴリ（電子機器、衣類、食品、本、スポーツ用品など）
- 15社のサプライヤー（企業名、連絡先情報含む）

**実習 1-3: 決済・配送方法の作成**

- 決済方法 5種類（クレジットカード、銀行振込、代金引換、コンビニ決済、電子マネー）
- 配送方法 4種類（通常配送、お急ぎ便、クール便、メール便）
- 配送時間帯設定

### Phase 2: 商品データの作成

**実習 2-1: 商品情報の作成**

MCPツールを使用して、以下の条件で商品を作成：

- 各カテゴリに10-15商品
- 商品コードは自動生成
- 現実的な価格設定（仕入価格 < 小売価格）
- 各サプライヤーに商品を割り当て

**実習 2-2: 在庫データの作成**

- 発注データ 50件
- 入荷データ 40件
- 商品と発注の関連付け

### Phase 3: 顧客・注文データの作成

**実習 3-1: 顧客データの作成**

- 100人の顧客情報
- 現実的な日本の名前とメールアドレス
- 配送先住所（都道府県、市区町村、番地）

**実習 3-2: 注文データの作成**

- 200件の注文
- 各注文に1-5個の商品
- 注文日は過去3ヶ月以内
- 様々な注文ステータス

**実習 3-3: 決済・配送データの作成**

- 各注文に対応する決済情報
- 配送情報（追跡番号、配送状況）
- 現実的な配送スケジュール

### Phase 4: 大量データの作成

**実習 4-1: 大量注文データの作成**

MCPツールを使用して、以下の大量データを作成：

- 1000件の注文
- 注文明細 3000件
- 決済情報 1000件
- 配送情報 1000件

**実習 4-2: データ整合性の確認**

作成したデータが以下の条件を満たしているか確認：

- 外部キー制約の違反なし
- ビジネスルールの遵守（在庫数、価格整合性など）
- 現実的なデータパターン

## MCPツールの実行例

### 基本的な使用方法

#### 1. データベース接続

```
use_mcp_tool({
  server_name: "postgres",
  tool_name: "connect_db",
  arguments: {
    host: "localhost",
    port: 5432,
    user: "user",
    password: "password",
    database: "ai_training"
  }
});
```

#### 2. テーブル構造の確認

```
# スキーマ一覧の取得
use_mcp_tool({
  server_name: "postgres",
  tool_name: "list_schemas",
  arguments: {}
});

# テーブル一覧の取得
use_mcp_tool({
  server_name: "postgres",
  tool_name: "list_tables",
  arguments: {}
});

# 特定のテーブルの構造を確認
use_mcp_tool({
  server_name: "postgres",
  tool_name: "describe_table",
  arguments: {
    table: "users"
  }
});
```

#### 3. データの作成

```
# Categories テーブルに10個のカテゴリを作成
use_mcp_tool({
  server_name: "postgres",
  tool_name: "execute",
  arguments: {
    sql: "INSERT INTO categories (name) VALUES ($1), ($2), ($3), ($4), ($5), ($6), ($7), ($8), ($9), ($10)",
    params: ["電子機器", "衣類・ファッション", "食品・飲料", "書籍・雑誌", "スポーツ・アウトドア", "家具・インテリア", "美容・健康", "おもちゃ・ゲーム", "車・バイク", "その他"]
  }
});

# Products テーブルに商品を作成
use_mcp_tool({
  server_name: "postgres",
  tool_name: "execute",
  arguments: {
    sql: "INSERT INTO products (code, name, category_id, supplier_id, retail_price, purchase_price) VALUES ($1, $2, $3, $4, $5, $6)",
    params: ["PROD001", "商品名", 1, 1, 1000, 800]
  }
});
```

#### 4. データの確認

```
# 作成したデータの確認
use_mcp_tool({
  server_name: "postgres",
  tool_name: "query",
  arguments: {
    sql: "SELECT * FROM categories ORDER BY id"
  }
});

# 条件を指定したデータの取得
use_mcp_tool({
  server_name: "postgres",
  tool_name: "query",
  arguments: {
    sql: "SELECT * FROM products WHERE category_id = $1",
    params: [1]
  }
});
```

#### 5. 複雑なリレーションデータの作成

```
# 注文データの作成例
use_mcp_tool({
  server_name: "postgres",
  tool_name: "execute",
  arguments: {
    sql: "INSERT INTO orders (site_id, shop_id, user_id, order_number, total_amount, shipping_fee, discount_amount, billing_amount, payment_method_id, delivery_method_id, order_date) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11)",
    params: [1, 1, 1, "ORD001", 1500.00, 200, 0.00, 1700.00, 1, 1, "2024-01-01"]
  }
});

# 注文明細の作成例
use_mcp_tool({
  server_name: "postgres",
  tool_name: "execute",
  arguments: {
    sql: "INSERT INTO order_items (order_id, product_id, category_id, product_code, product_name, quantity, unit_price) VALUES ($1, $2, $3, $4, $5, $6, $7)",
    params: [1, 1, 1, "PROD001", "商品名", 1, 1000.00]
  }
});
```

### 利用可能なMCPツール

#### 1. connect_db
データベースへの接続を確立します。

- **用途**: PostgreSQLデータベースへの接続
- **必要なパラメータ**: host, port, user, password, database

#### 2. list_schemas
データベース内のスキーマ一覧を取得します。

- **用途**: データベース構造の把握
- **パラメータ**: なし

#### 3. list_tables
指定したスキーマ内のテーブル一覧を取得します。

- **用途**: テーブル構造の把握
- **パラメータ**: schema（オプション、デフォルト: public）

#### 4. describe_table
指定したテーブルの構造を詳細に取得します。

- **用途**: テーブルの列情報、型、制約の確認
- **パラメータ**: table（必須）, schema（オプション）

#### 5. query
SELECTクエリを実行してデータを取得します。

- **用途**: データの検索・確認
- **パラメータ**: sql（必須）, params（オプション）
- **対応**: PostgreSQL形式（$1, $2）とMySQL形式（?）の両方

#### 6. execute
INSERT, UPDATE, DELETEクエリを実行します。

- **用途**: データの作成・更新・削除
- **パラメータ**: sql（必須）, params（オプション）
- **対応**: PostgreSQL形式（$1, $2）とMySQL形式（?）の両方

### 効率的なデータ作成のコツ

1. **段階的な作成**: 依存関係の順序を守る
2. **現実的なデータ**: 実際の使用シーンを想定
3. **バリエーション**: 偏りのないデータ分布
4. **関連性の確保**: 外部キーの整合性
5. **プリペアドステートメントの活用**: SQLインジェクションを防ぐ
6. **エラーハンドリング**: 適切なエラー処理と復旧

## 注意事項とベストプラクティス

### 重要な注意点

1. **データベースの変更リスク**
   - MCPツールは直接データベースを操作します
   - 誤った操作でテーブル構造が変更される可能性があります
   - 作業前に必ずデータベースのバックアップを取得してください

2. **開発環境での使用**
   - 本番環境では絶対に使用しないでください
   - ローカル環境でのテスト・開発用途に限定してください

3. **データの整合性**
   - 外部キー制約を意識してデータを作成してください
   - ビジネスルールに従ったデータを作成してください

### ベストプラクティス

1. **段階的な作成**

   ```
   1. マスタデータ（カテゴリ、サプライヤー、決済方法など）
   2. 商品データ
   3. 顧客データ
   4. 注文データ
   ```

2. **データの検証**

   ```bash
   # データ作成後は必ず確認
   pnpm db:studio
   ```

3. **エラー時の対応**

   ```bash
   # エラーが発生した場合はリセット
   pnpm db:reset
   pnpm db:seed
   ```

4. **バックアップの取得**
   ```bash
   # 重要なデータ作成前にバックアップ
   pg_dump -h localhost -U user -d ai_training > backup.sql
   ```

## 学習の進め方

1. **Phase 1-2**: 基本的なMCPツールの使い方を習得
2. **Phase 3**: 複雑なリレーションデータの作成方法を学習
3. **Phase 4**: 大量データの効率的な作成方法をマスター

各フェーズで作成したデータは Prisma Studio で確認し、期待通りのデータが作成できているか検証してください。

## 完了後の確認項目

- [ ] 全てのテーブルにテストデータが作成されている
- [ ] 外部キー制約が正しく設定されている
- [ ] 1000件以上の注文データが作成されている
- [ ] データの整合性が保たれている
- [ ] 現実的なデータパターンが作成されている

このハンズオンを通じて、MCPツールを使用した効率的なテストデータ作成手法を習得し、実際の開発現場で活用できるスキルを身につけてください。
